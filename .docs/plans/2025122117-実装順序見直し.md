# コーディング計画: 実装順序見直し

作成日時: 2025-12-21 17:52
参照アイディアファイル: `01-アプリの実装開始.md`
参照プランファイル: `2025122018-コマンドランチャー基本機能.md`

## 背景

- 既存プランでは「常駐とタスクトレイ」を先に進める構成になっている
- ただし現状は GUI 未実装、並行処理ランタイム未導入のため、常駐やトレイ中心の制御を先に固めると実装が難航しやすい
- そのため、実装順序を以下に変更して段階的に到達する

## 前提となる現在地

- 手順 2. コマンド実行機構 まで実装済み
  - 設定パス解決
  - setting.yaml / env.yaml 読み込み
  - 設定に基づくコマンド起動
- 未実装
  - UI
  - グローバルホットキー
  - フルスクリーン判定とホットキー無効化
  - 常駐とタスクトレイ

## 実装する機能

- 最小 UI（コマンド選択と実行）
- グローバルホットキー（UI 表示）
- フルスクリーン検知とホットキー無効化
- 常駐とタスクトレイ（ホットキー無効状態でアイコン切替）

## 実装順序（更新後）

### 3. 最小 UI（コマンド選択と実行）

- 目的
  - 設定から読み込んだコマンド一覧を UI で選択して実行できる状態にする
  - トレイやホットキーの前に、アプリとしての中核価値を成立させる
- 最小要件
  - 入力ができるコマンド領域
  - 入力文字列をエンターで実行
  - 入力文字列が CommandSpec.name に一致する場合は runner 経由で実行する
  - 一致しない場合は UI 上にエラーを表示する（初回はログ出力でも可）
  - 設定読み込み失敗や起動失敗を UI 上に表示できる（初回はログ出力でも可）
- 技術方針
  - UI は egui（eframe）を第一候補として評価する
  - まずは単一ウィンドウで起動し、常駐や非表示起動は後続で対応する
  - コマンド実行は spawn を基本とし、UI スレッドのブロッキングを避ける
- 受け入れ確認
  - cargo build が通る
  - 設定が存在する環境で、UI から任意のコマンドを 1 件起動できる

### 4. グローバルホットキー

- 目的
  - 1 つのグローバルホットキーで UI を表示できるようにする
- 最小要件
  - crate global-hotkey を導入し、ホットキーを登録できる
  - アプリからフォーカスを外したら非表示にする
  - ホットキー押下で UI を表示できる
  - UI がすでに表示中の場合は、前面に出してフォーカスする（表示状態のトグルはしない）
  - 登録失敗時はログ出力し、アプリは終了する
- 技術方針
  - global-hotkey のイベント通知はチャネルで受け取り、UI 側に反映する
  - 並行処理ランタイムは導入せず、スレッドとチャネルで完結させる
  - UI の表示は最小の制御（前面化、フォーカス）から開始する
  - 非表示化はフォーカス喪失を契機に行う
- 受け入れ確認
  - cargo build が通る
  - 手動でホットキーを押下して、UI が表示され前面化される

### 5. フルスクリーン検知とホットキー無効化

- 目的
  - フルスクリーン動作中はホットキーを無効化できる
- 最小要件
  - 前面ウィンドウの矩形を取得する
  - 対象モニタの領域（作業領域または全領域）を取得する
  - 両者が十分に一致する場合にフルスクリーンと判定する
  - フルスクリーン判定が真のとき、ホットキーイベントを無視する
- 技術方針
  - windows（windows-rs）を使用する
  - 閾値（許容差 px、作業領域か全領域か）は定数で定義し、将来設定に外出ししやすい形にする
  - まずはログで、ホットキーが無視されたことを確認できるようにする
- 受け入れ確認
  - cargo build が通る
  - フルスクリーンアプリが前面のとき、ホットキーで UI が切り替わらない

### 6. 常駐とタスクトレイ

- 目的
  - UI をデフォルト非表示で常駐させ、トレイ操作とホットキーで UI を呼び出せるようにする
  - ホットキー有効/無効状態が視覚的に分かるようにアイコンを切り替える
- 最小要件
  - 常駐中はタスクトレイにアイコンを表示する
  - 左クリックまたはダブルクリックで UI 表示をトグルできる
  - 右クリックのコンテキストメニューから終了できる
  - ホットキー無効化中（フルスクリーン判定が真）を示すアイコンに切り替える
- 技術方針
  - tray-icon を第一候補として評価する
  - 並行処理ランタイムは導入せず、スレッドとチャネルで UI 制御とトレイイベントを接続する
  - アイコンは最初は暫定（同一アイコンでも可）で動作確認を優先し、差し替え可能な形にする
- 受け入れ確認
  - cargo build が通る
  - UI を閉じた状態でもプロセスが常駐し、トレイ操作で UI を表示できる
  - フルスクリーン時にトレイアイコンが切り替わる

## 次の分割が必要になった場合

- 6 の常駐とトレイが UI フレームワークの都合で難航する場合は、以下で分割する
  - 6-1: トレイ表示と終了メニューのみ（UI トグルは後回し）
  - 6-2: トレイ操作で UI トグル、ホットキー状態に応じたアイコン切替
