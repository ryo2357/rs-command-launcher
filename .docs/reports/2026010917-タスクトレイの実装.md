# 実装報告書: タスクトレイの実装

- 対象コミット
  - 1a22b0ac55b570413285b3d3566efae055a0b786
  - タスクトレイの実装。表示非表示を eframe 側に戻したら非表示後に機能が動かない

## 目的

- 常駐利用の前段として、タスクトレイから表示と終了ができる導線を追加する
- ホットキーとタスクトレイの入力を eframe/egui の update ループ側で処理できるように整理する

## 実装内容

- 依存関係の追加

  - tray-icon を追加し、タスクトレイアイコンとメニューを作成できるようにした
  - image を追加し、埋め込み PNG からトレイ用アイコンを生成できるようにした

- トレイアイコンとメニューの追加

  - src/ui/task_tray.rs を新規追加
  - assets/tray.png を追加し、include_bytes! で埋め込み読み込みする
  - メニュー項目
    - 表示
    - 終了
  - メニューイベントは別スレッドで受け取り、アプリ側へ TrayCommand を送信する

- アプリ側でのトレイコマンド処理

  - src/ui/app.rs にタスクトレイ保持と受信チャネルを追加
  - update ループ内で TrayCommand をポーリングし、表示と終了を実行する
    - 表示は ShowWindow と SetForegroundWindow で前面化する
    - 終了は WM_CLOSE を投げ、非表示中でも確実に終了できるようにする

- ホットキー処理の整理

  - src/ui/hotkey.rs の責務を、ウィンドウの直接制御から通知型へ変更した
  - WM_HOTKEY を受けたらチャンネルでトグル要求を送信する
  - update を確実に起こすため、egui の request_repaint と Win32 の WM_NULL を送る
  - src/ui/app.rs でホットキー通知を受け、表示/非表示の切り替えを行う

- 非表示中に update が止まりやすい問題への対処
  - ウィンドウ非表示中でもトレイ/ホットキー受信処理が回るよう、一定間隔で request_repaint_after を行う

## 仕様書への反映

- .docs/specs/project.md

  - UI モジュール構成に src/ui/task_tray.rs を追記
  - タスクトレイ（表示、終了）を実装済みへ追加
  - ホットキー処理の責務と、非表示中の update 維持の仕様を追記

- .docs/specs/history.md
  - 2026-01-09 分の仕様変更履歴を追記

## 影響範囲と注意点

- Alt+Space は Windows のシステムメニューと競合しやすく、ホットキー登録が失敗する場合がある
- ウィンドウ非表示中に eframe/egui の update が止まる環境では、トレイ/ホットキーが反応しない可能性がある
  - 現状は request_repaint_after と WM_NULL 送信で回避を試みている
- Windows 専用 API を利用しているため、他 OS の動作は考慮していない

## 動作確認

- ビルド
  - cargo build
- 実行
  - cargo run
- 動作
  - トレイメニューの 表示 でウィンドウが前面表示される
  - トレイメニューの 終了 でアプリが終了する
  - Alt+Space で表示/非表示が切り替わる
