# 実装報告書: 構成変更（controller 分離）

- 対象コミット
  - d555234c33ed0c53a4363069553759c30e5ea47c
  - 構成の変更

## 目的

- eframe/egui の update ループ内で常駐系の処理（ホットキー、タスクトレイ）を扱う構成に無理があったため、責務を分離して安定した構成に変更する
- UI は最小 UI と HWND の通知に限定し、ホットキーによる表示切り替えは UI 外で制御できるようにする

## 実装内容

- アプリ層の追加

  - src/app/endpoint.rs を追加
    - Controller と UI / Hotkey / Tray 間の通信用エンドポイントを mpsc で定義
  - src/app/controller.rs を追加
    - UI から HWND を受け取り保持
    - Hotkey からのトグル通知で ShowWindow により表示/非表示を切り替え
    - 終了シグナル受信時に Hotkey 側へ終了コマンドを送信
  - src/app/hotkey.rs を追加
    - Alt+Space のグローバルホットキーを別スレッドで登録し、検知結果を Controller へ通知
    - Controller からの Register / Finish コマンドを受け付け

- UI の責務整理

  - src/ui/launcher.rs を追加
    - 最小 UI（コマンド名入力と実行）
    - 初回 update で HWND を取得し Controller へ通知
    - Controller からの UI コマンド受信枠を用意（現状は未使用）
  - src/ui/startup.rs を src/ui/native_runner.rs にリネームし、UI 起動処理を eframe_startup として整理
  - src/ui/app.rs と src/ui/hotkey.rs を削除

- エントリーポイントの変更

  - src/main.rs で起動経路を整理
    - 引数なし起動で Controller + Hotkey + UI を起動
    - Controller は別スレッドで常駐ループを回す

- タスクトレイについて
  - src/ui/task_tray.rs を src/app/task_tray.rs へ移動
  - 現状は起動経路と Controller 連携が未実装

## 仕様書への反映

- .docs/specs/project.md
  - 新しいモジュール構成（src/app/_ と src/ui/_）を反映
  - タスクトレイを未実装へ戻して整理
- .docs/specs/history.md
  - 2026-01-13 分の仕様変更履歴を追記

## 影響範囲と注意点

- Alt+Space は Windows のシステムメニューと競合しやすく、ホットキー登録が失敗する可能性がある
- タスクトレイはファイルのみ移動済みで、現時点では機能として未提供
- UI と常駐系処理がスレッド分離されたため、終了順序とスレッド join の扱いに注意が必要

## 動作確認

- ビルド
  - cargo build
- 実行
  - cargo run
- 動作
  - UI が起動し、コマンド入力で起動できる
  - Alt+Space の通知により表示/非表示が切り替わる
