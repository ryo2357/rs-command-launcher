# 実装報告書: タスクトレイ機能の実装

- 対象コミット
  - 902cebc43477ad3f44c73c900e4409377ffb6309
  - タスクトレイ機能の実装

## 目的

- タスクトレイを起動経路に組み込み、表示と終了の導線を追加する
- Controller 中心の構成に合わせて、UI とタスクトレイを疎結合にする

## 実装内容

- ビルド時にトレイアイコンを埋め込む仕組みを追加

  - build.rs を追加
  - assets/tray.png をビルド時にデコードし、RGBA データを OUT_DIR 配下の Rust ソースとして生成する
  - 実行時は include! で生成物を取り込み、tray-icon の Icon を組み立てる

- タスクトレイのイベントループを実装

  - src/app/task_tray.rs を Controller 連携前提の実装へ更新
  - メニュー
    - Show Window
    - Quit
  - Win32 メッセージをポンプする処理を追加し、右クリックなどの反応を維持する
  - Controller からの終了指示を受け取れるようにして、スレッドの終了を制御する
  - ポーリングによる CPU 負荷を抑えるため、短いスリープを挿入する

- Controller とタスクトレイ間の通信を双方向に整理

  - src/app/endpoint.rs
  - コントローラー <- タスクトレイ
    - TrayEvent
      - ShowWindow
      - Quit
  - コントローラー -> タスクトレイ
    - TrayCmd
      - Finish

- タスクトレイの入力に応じた挙動を Controller に追加

  - src/app/controller.rs
  - 表示
    - ShowWindow と SetForegroundWindow により前面表示を試みる
    - 表示時に UI へフォーカス要求コマンドを送る
  - 終了
    - UI のウィンドウへ WM_CLOSE を PostMessageW で送信し、終了を要求する
  - 終了処理
    - Controller 側の終了要求を受けた際、Hotkey と TaskTray に Finish を送信してスレッドを停止する

- UI 側のコマンド経路を追加

  - src/app/endpoint.rs
    - UiCommand::ForcusInput を追加
  - src/ui/launcher.rs
    - UiCommand を受信する処理を追加
    - 現状は入力欄へフォーカスを移す処理は未実装で、将来拡張のための受け口のみ用意している

- ポーリングループの CPU 負荷を抑制
  - src/app/controller.rs
  - src/app/hotkey.rs
  - ループ末尾に短いスリープを追加する

## 仕様書への反映

- .docs/specs/project.md

  - build.rs の役割（ビルド時のアイコン埋め込み）を追記
  - src/app/task_tray.rs が Controller 連携済みであることを追記
  - 実装済みに タスクトレイ（表示、終了）を追記

- .docs/specs/history.md
  - 2026-01-14 の仕様変更履歴を追記

## 影響範囲と注意点

- SetForegroundWindow は OS の制約により失敗する場合がある
- タスクトレイは Win32 のメッセージ処理に依存するため、他 OS は対象外
- タスクトレイループはポーリングを含むため、スリープ値の調整余地がある

## 動作確認

- ビルド
  - cargo build
- 実行
  - cargo run
- 動作
  - タスクトレイメニューの Show Window でウィンドウが表示される
  - タスクトレイメニューの Quit でアプリが終了する
  - Alt+Space で表示/非表示が切り替わる
